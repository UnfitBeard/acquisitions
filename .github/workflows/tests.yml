name: Tests & Coverage

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      # Provide a default DB URL if user hasn't set one in repo secrets or env -
      # override in repo secrets / environment in GitHub as needed.
      DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgres://localhost:5432/testdb' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20.x (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests (capture output & exit code)
        id: run-tests
        shell: bash
        run: |
          set -o pipefail
          # Create a directory for logs so we can attach it if needed
          mkdir -p test-output
          # Run tests and store output to file
          npm test 2>&1 | tee test-output/test.log
          TEST_EXIT=${PIPESTATUS[0]}
          echo "exit_code=$TEST_EXIT" >> $GITHUB_OUTPUT
          # Save simple coverage report path if generated by your test setup
          # (adjust path if you have a custom coverage output)
          if [ -d coverage ]; then
            echo "coverage_exists=true" >> $GITHUB_OUTPUT
          else
            echo "coverage_exists=false" >> $GITHUB_OUTPUT
          fi
          # Do not exit here so we can upload artifacts and write summary; evaluate exit later.

      - name: Upload test log
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: test-output/test.log
          retention-days: 30

      - name: Upload coverage (if present)
        if: steps.run-tests.outputs.coverage_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage
          retention-days: 30

      - name: Generate GitHub Actions step summary (tests & coverage)
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = parseInt(core.getInput('exit_code') || '0');
            const coverageExists = core.getInput('coverage_exists') === 'true';
            let summary = `## Test results\n\n`;
            if (exitCode === 0) {
              summary += `‚úÖ All tests passed (exit code 0).\n\n`;
            } else {
              summary += `‚ùå Some tests failed (exit code ${exitCode}). See uploaded test-log artifact.\n\n`;
            }
            if (coverageExists) {
              summary += `üìä Coverage report uploaded as an artifact (retained for 30 days).\n\n`;
            } else {
              summary += `‚ÑπÔ∏è No coverage report found in \`coverage/\`. If you expect coverage, ensure your test runner outputs it to \`coverage/\`.\n\n`;
            }
            summary += `**Artifacts**\n- test-log\n${coverageExists ? '- coverage-report' : ''}\n`;
            core.summary.addRaw(summary);
          inputs:
            exit_code: ${{ steps.run-tests.outputs.exit_code }}
            coverage_exists: ${{ steps.run-tests.outputs.coverage_exists }}

      - name: Add annotations on test failures
        if: steps.run-tests.outputs.exit_code != '0'
        shell: bash
        run: |
          # Add an actionable annotation pointing to the uploaded test-log artifact
          echo "::error::Tests failed. See uploaded artifact 'test-log' for full output."
          # Optionally, include first lines of the log to make quick triage easier
          echo "----- BEGIN TEST LOG SNIPPET -----"
          head -n 80 test-output/test.log || true
          echo "----- END TEST LOG SNIPPET -----"
          # Fail the job now that we've created annotations and uploaded artifacts
          exit 1

      - name: Finish - tests passed
        if: steps.run-tests.outputs.exit_code == '0'
        run: echo "Tests finished successfully ‚úÖ"
